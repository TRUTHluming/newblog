<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>working (ARmode)</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden;
    font-family: Arial, sans-serif;
    color: white;
  }
  #camera-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: -1;
  }
  #task-area {
    position: relative;
    width: 100%;
    height: 100vh;
    overflow: hidden;
  }
  .task {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,215,0,0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: black;
    font-weight: bold;
    animation: float 6s infinite ease-in-out;
  }
  @keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
    100% { transform: translateY(0); }
  }
  #ui {
    position: absolute;
    top: 10px; left: 0;
    width: 100%;
    text-align: center;
  }
  #money, #goal, #status, #distance {
    margin: 5px 0;
    font-size: 18px;
    text-shadow: 1px 1px 3px #000;
  }
  #complete {
    display: none;
    font-size: 22px;
    color: lime;
    margin-top: 15px;
  }
</style>
</head>
<body>

<video id="camera-bg" autoplay playsinline muted></video>

<div id="task-area"></div>

<div id="ui">
  <div id="money">ğŸ’° 0</div>
  <div id="goal">goal: --</div>
  <div id="status">waiting mission...</div>
  <div id="distance">mission distance: --</div>
  <div id="complete">ğŸ‰ congralation!</div>
</div>

<script>
let startPos = null;
let watchId = null;
let hasCompleted = false;
let targetDistance = 0;
let rewardCoins = 0;

// å¯åŠ¨æ‘„åƒå¤´èƒŒæ™¯
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
  .then(stream => {
    const video = document.getElementById('camera-bg');
    video.srcObject = stream;
  })
  .catch(err => alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥ç»§ç»­æ¸¸æˆ"));

// éšæœºç”Ÿæˆä»»åŠ¡æ³¡æ³¡
function createTasks() {
  const area = document.getElementById('task-area');
  for (let i = 0; i < 5; i++) {
    const task = document.createElement('div');
    const distance = Math.floor(Math.random() * 6) + 5; // 5~10ç±³
    const reward = Math.floor(distance * 1.5);

    task.className = 'task';
    task.style.width = task.style.height = `${60 + Math.random() * 40}px`;
    task.style.left = `${Math.random() * 80 + 10}%`;
    task.style.top = `${Math.random() * 70 + 10}%`;
    task.innerHTML = `<div>${distance}m</div><div>ğŸ’°${reward}</div>`;
    task.onclick = () => startMission(distance, reward);
    area.appendChild(task);
  }
}

function startMission(distance, reward) {
  targetDistance = distance;
  rewardCoins = reward;
  document.getElementById('goal').textContent = `goal: ${targetDistance}m`;
  document.getElementById('status').textContent = `walking...`;
  document.getElementById('task-area').innerHTML = '';
  startTracking();
}

// å¼€å§‹åœ°ç†å®šä½è¿½è¸ª
function startTracking() {
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(pos => {
      if (!startPos) startPos = pos.coords;
      const dist = calcDistance(startPos.latitude, startPos.longitude, pos.coords.latitude, pos.coords.longitude);
      updateUI(dist);
    }, err => {
      document.getElementById('status').textContent = "âš ï¸ location needed";
    }, { enableHighAccuracy: true });
  }
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function updateUI(dist) {
  if (hasCompleted) return;
  document.getElementById('distance').textContent = `goal distance: ${dist.toFixed(1)} m / ${targetDistance} m`;
  const progress = Math.min(dist / targetDistance, 1);
  document.getElementById('money').textContent = `ğŸ’° ${Math.floor(progress * rewardCoins)}`;
  if (dist >= targetDistance) {
    hasCompleted = true;
    document.getElementById('status').textContent = "misson success!";
    document.getElementById('complete').style.display = "block";
    navigator.geolocation.clearWatch(watchId);
  }
}

createTasks();
</script>
</body>
</html>

