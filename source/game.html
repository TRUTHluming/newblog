<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Street Survival: The Coderâ€™s Quest</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    margin: 0;
    background: linear-gradient(#c8e9ff, #f0f9ff);
    overflow: hidden;
  }
  h2 { margin-top: 20px; }
  #bubble-area {
    position: relative;
    width: 100%;
    height: 80vh;
    overflow: hidden;
  }
  .bubble {
    position: absolute;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    cursor: pointer;
    animation: float 8s infinite ease-in-out;
    text-shadow: 1px 1px 2px #000;
  }
  .bubble.gold {
    background: radial-gradient(circle, gold, orange);
    box-shadow: 0 0 15px gold;
  }
  .bubble.normal {
    background: rgba(0,150,255,0.6);
  }
  @keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-40px); }
    100% { transform: translateY(0); }
  }
  #game {
    display: none;
    margin-top: 40px;
  }
  #complete {
    font-size: 22px;
    color: green;
    margin-top: 20px;
    display: none;
  }
  #ar-scene {
    display: none;
    width: 100%;
    height: 100vh;
  }
  button {
    margin: 10px;
    padding: 10px 20px;
  }
</style>
</head>
<body>

<h2>Street Survival: The Coderâ€™s Quest</h2>

<!-- æ³¡æ³¡ä»»åŠ¡é€‰æ‹©ç•Œé¢ -->
<div id="bubble-area"></div>

<!-- æ¸¸æˆè¿›è¡Œç•Œé¢ -->
<div id="game">
  <div id="money">ğŸ’° 0</div>
  <div id="goal">Goal: --</div>
  <p id="status">Start walking to complete your mission...</p>
  <p id="distance">Distance moved: 0 m</p>
  <p id="complete">ğŸ‰ Mission Complete!</p>
  <button onclick="restartGame()">Restart</button>
  <button onclick="showAR()">Enter AR View</button>
</div>

<!-- AR å®æ™¯åœºæ™¯ -->
<a-scene id="ar-scene" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-marker-camera preset="hiro"></a-marker-camera>
  <a-box id="targetBox" position="0 0 0" color="yellow" scale="0.5 0.5 0.5"></a-box>
</a-scene>

<script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ar.js@3.3.2/aframe/build/aframe-ar.js"></script>

<script>
let startPos = null;
let watchId = null;
let hasCompleted = false;
let targetDistance = 0;
let rewardCoins = 0;

// åˆ›å»ºæ³¡æ³¡ä»»åŠ¡
function createBubbles() {
  const area = document.getElementById('bubble-area');
  for (let i = 0; i < 10; i++) {
    const bubble = document.createElement('div');
    const isGold = Math.random() < 0.1; // 10% é«˜çº§ä»»åŠ¡
    const distance = isGold ? 5 : Math.floor(Math.random() * 3) + 8; // é‡‘è‰²çŸ­ä»»åŠ¡5mï¼Œæ™®é€š8â€“10m
    const reward = isGold ? 10 : Math.floor(distance * 0.5);

    bubble.className = 'bubble ' + (isGold ? 'gold' : 'normal');
    bubble.innerHTML = isGold
      ? `<div>â˜… GOLD â˜…</div><div>${distance}m | ğŸ’°${reward}</div>`
      : `<div>${distance}m</div><div>ğŸ’°${reward}</div>`;

    // è®¾ç½®æ³¡æ³¡ä½ç½®ä¸å¤§å°
    bubble.style.width = bubble.style.height = `${60 + Math.random() * 40}px`;
    bubble.style.left = `${Math.random() * 80 + 10}%`;
    bubble.style.top = `${Math.random() * 60 + 10}%`;

    bubble.dataset.distance = distance;
    bubble.dataset.reward = reward;
    bubble.dataset.type = isGold ? 'gold' : 'normal';

    bubble.onclick = () => startMission(bubble.dataset);
    area.appendChild(bubble);
  }
}

// å¼€å§‹ä»»åŠ¡
function startMission(data) {
  targetDistance = parseFloat(data.distance);
  rewardCoins = parseInt(data.reward);
  document.getElementById('bubble-area').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  document.getElementById('goal').textContent =
    `${data.type === 'gold' ? 'â˜… GOLD MISSION â˜…' : 'Mission'}: ${targetDistance}m for ${rewardCoins} coins`;
  startTracking();
}

// å¼€å¯å®šä½è¿½è¸ª
function startTracking() {
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(pos => {
      if (!startPos) startPos = pos.coords;
      const dist = haversine(startPos.latitude, startPos.longitude, pos.coords.latitude, pos.coords.longitude);
      updateDisplay(dist);
    }, err => {
      document.getElementById('status').textContent = "âš ï¸ Please enable location access.";
    }, { enableHighAccuracy: true });
  } else {
    document.getElementById('status').textContent = "Location not supported.";
  }
}

// è®¡ç®—è·ç¦»
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// å®æ—¶æ›´æ–°æ¸¸æˆçŠ¶æ€
function updateDisplay(dist) {
  if (hasCompleted) return;
  document.getElementById("distance").textContent = `Distance moved: ${dist.toFixed(1)} m / ${targetDistance} m`;
  const progress = Math.min(dist / targetDistance, 1);
  const money = Math.floor(progress * rewardCoins);
  document.getElementById("money").textContent = `ğŸ’° ${money}`;

  if (dist >= targetDistance) {
    hasCompleted = true;
    document.getElementById("status").textContent = "ğŸ¯ Youâ€™ve reached your goal!";
    document.getElementById("complete").style.display = "block";
    navigator.geolocation.clearWatch(watchId);
  }
}

// æ˜¾ç¤ºARå®æ™¯
function showAR() {
  document.getElementById('game').style.display = 'none';
  document.getElementById('ar-scene').style.display = 'block';
  alert('ğŸ“¸ Use your camera to find the yellow mission point!');
}

// é‡ç½®æ¸¸æˆ
function restartGame() {
  location.reload();
}

// åˆå§‹åŒ–æ³¡æ³¡ä»»åŠ¡
createBubbles();
</script>
</body>
</html>
